import fetch from 'node-fetch';
import * as cheerio from 'cheerio';

class UserProfileService {
    constructor() {
        this.finalUrl = "https://classic.sejong.ac.kr/classic/reading/status.do";
    }
    
    async getUserProfile(ssotoken) {
        try {
            //console.log("ğŸ“œ ssotoken:", ssotoken);  // ssotokenì„ ì½˜ì†”ì— ì¶œë ¥

            // ìµœì¢… ë°ì´í„° ìš”ì²­
            const finalResponse = await fetch(this.finalUrl, {
                method: "GET",
                headers: {
                    "Cookie": `ssotoken=${ssotoken};`,
                },
                credentials: "include",
            });

            const html = await finalResponse.text();
            
            const profileData = this.extractProfileData(html); // í•™ê³¼ëª…, í•™ë²ˆ, ì´ë¦„, í•™ë…„ ì¶”ì¶œ
            //console.log(profileData);
            return { body: profileData }; // response.bodyë¡œ ë°˜í™˜

        } catch (error) {
            console.error(error);
            throw new Error("Failed: Failed to fetch user profile");
        }
    }

    extractProfileData(html) {
        const $ = cheerio.load(html);

        // í•„ìš”í•œ ë°ì´í„° ì¶”ì¶œ
        const major = $("th:contains('í•™ê³¼ëª…')").next().text().trim();
        const studentId = $("th:contains('í•™ë²ˆ')").next().text().trim();
        const name = $("th:contains('ì´ë¦„')").next().text().trim();
        const gradeLevel = $("th:contains('í•™ë…„')").next().text().trim();

        if (!major || !studentId || !name || !gradeLevel) {
            throw new Error('í•„ìˆ˜ ë°ì´í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        return {
            major,
            studentId,
            name,
            gradeLevel
        };
    }
}

export default UserProfileService;
